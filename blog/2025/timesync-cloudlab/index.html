<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Microsecond-Level Time Synchronization on CloudLab | Varun Gohil</title> <meta name="author" content="Varun Gohil"> <meta name="description" content="for reliable jaeger tracing"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/vg.png?d973fb19bbba323fbe4637d34029f255"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://varungohil.github.io/blog/2025/timesync-cloudlab/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Varun </span>Gohil</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About</a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/service/">Service</a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/index.html">Blog</a> </li> <li class="nav-item "> <a class="nav-link" target="_blank" href="/assets/pdf/my_cv.pdf">CV</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Microsecond-Level Time Synchronization on CloudLab</h1> <p class="post-meta">March 16, 2025</p> <p class="post-tags"> <a href="/blog/2025"> <i class="fas fa-calendar fa-sm"></i> 2025 </a>   ·   <a href="/blog/tag/technical"> <i class="fas fa-hashtag fa-sm"></i> technical</a>   <a href="/blog/tag/computer-systems"> <i class="fas fa-hashtag fa-sm"></i> computer-systems</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <p>Ever tried to run distributed experiments only to have your Jaeger traces and results ruined by out-of-sync time? Yeah, been there! After banging my head against this problem for a while, I finally found a simple solution to get microsecond-level time synchronization between <a href="https://cloudlab.us/" rel="external nofollow noopener" target="_blank">CloudLab</a> machines. Let me walk you through it!</p> <h2 id="the-problem-internet-ntp-is-too-slow">The Problem: Internet NTP Is Too Slow</h2> <p>When you setup up <a href="https://cloudlab.us/" rel="external nofollow noopener" target="_blank">CloudLab</a> machines, they’re configured to sync their time with Internet NTP servers. Sounds great, but there’s a problem - it leads to significant millisecond-level time differences between machines that are synchronizing with that internet NTP server.</p> <p>Let’s start by measuring time difference on a 2-machine setup. I’ll be using <strong><em>chrony</em></strong> - an NTP tool; so first, let’s install chrony on both machines:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt-get update
sudo apt-get install chrony
</code></pre></div></div> <p>Now, to measure the time difference, run the following command on machines:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chronyc tracking
</code></pre></div></div> <p>Images below show the output of the command on both machines:</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/time-sync/initial-skew-measurement-0-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/time-sync/initial-skew-measurement-0-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/time-sync/initial-skew-measurement-0-1400.webp"></source> <img src="/assets/img/time-sync/initial-skew-measurement-0.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/time-sync/initial-skew-measurement-1-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/time-sync/initial-skew-measurement-1-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/time-sync/initial-skew-measurement-1-1400.webp"></source> <img src="/assets/img/time-sync/initial-skew-measurement-1.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>There are a lot of numbers in the images above, but the most important ones for us are <em>Last Offset</em> and <em>RMSE Offset</em>. Last offset reports the last measured time difference between our machine and the reference machine. RMSE offset reports the root mean squared time difference between our machine and the reference machine over a period of time.</p> <p>For node-0, the last offset is 20.3 μs and RMSE offset is 490 μs. For node-1, both the last offset and RMSE offset values are 2.36 ms! This means the time difference between both machines is also in the order of a millisecond. While this might sound small, it is a huge problem when dealing with microservice application where each service takes only 100s of microseconds. A time difference of a milliseond can lead to useless and garbage Jaeger traces which do not facilitate debugging or performance analysis.</p> <p>So, let’s see what is this authoritaive time source server that our machine is talking to. Take a peek at in <code class="language-plaintext highlighter-rouge">/etc/chrony/chrony.conf</code>, you’ll see some lines like these:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pool ntp.ubuntu.com        iburst maxsources 4
pool 0.ubuntu.pool.ntp.org iburst maxsources 1
pool 1.ubuntu.pool.ntp.org iburst maxsources 1
pool 2.ubuntu.pool.ntp.org iburst maxsources 2
</code></pre></div></div> <p>These lines tell chrony to synchronize your machine’s time with time from one of the following sources: <code class="language-plaintext highlighter-rouge">ntp.ubuntu.com </code>, <code class="language-plaintext highlighter-rouge">0.ubuntu.pool.ntp.org</code>, <code class="language-plaintext highlighter-rouge">1.ubuntu.pool.ntp.org</code> and <code class="language-plaintext highlighter-rouge">2.ubuntu.pool.ntp.org</code>.</p> <p><code class="language-plaintext highlighter-rouge">ntp.ubuntu.com</code> is the official Ubuntu NTP server while <code class="language-plaintext highlighter-rouge">*.ubuntu.pool.ntp.org</code> are servers part of the <a href="https://www.ntppool.org/en/" rel="external nofollow noopener" target="_blank">NTP Pool Project</a>. More importantly, all these authoritative time sources are accessible on the internet and are not locally located with your cluster. This results in longer communication times between your machines and internet NTP server, which can degrade time synchronization. You can also see this in the images above. <em>Root Delay</em> measures the total round-trip network delay between your machine and the NTP server. The root delay on node-0 is 46ms while on node-1 it is 24.5ms. Having millisecond level root delays makes it harder to achieve microsecond level time synchronization. So what do we do?</p> <h2 id="the-solution-local-time-server">The Solution: Local Time Server</h2> <p>Here’s the simple and obvious trick: instead of having all your machines sync with Internet NTP servers, designate one machine as the local time server and have the others sync with it. This avoids the internet access latency, lowers your root delay and dramatically improves time synchronization.</p> <p>Here, I’m going to designate node-0 as my local time server and synchronize node-1’s time with my local node-0 time server. Here’s how to set it up:</p> <p>On the machine you want to use as your time server (I chose node-0), modify its <code class="language-plaintext highlighter-rouge">/etc/chrony/chrony.conf</code> like this:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#pool ntp.ubuntu.com        iburst maxsources 4
#pool 0.ubuntu.pool.ntp.org iburst maxsources 1
#pool 1.ubuntu.pool.ntp.org iburst maxsources 1
#pool 2.ubuntu.pool.ntp.org iburst maxsources 2

local stratum 10

allow 10.10.1.2
</code></pre></div></div> <p>Here I’ve commented out lines asking chrony to sync time with internet NTP servers. The <code class="language-plaintext highlighter-rouge">local stratum</code> line makes node-0 act as a time server now. The number following it can be any number greater than 0. The <code class="language-plaintext highlighter-rouge">allow &lt;ip&gt;</code> line allows the machine with the given ip to use this server as it’s time server. In my setup 10.10.1.2 was the ip of node-1 so this line allows node-1 to use node-0 as a time server.</p> <p>On the machines who should be using this new local time server (node-1 in my case), modify the <code class="language-plaintext highlighter-rouge">/etc/chrony/chrony.conf</code> like this:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#pool ntp.ubuntu.com        iburst maxsources 4
#pool 0.ubuntu.pool.ntp.org iburst maxsources 1
#pool 1.ubuntu.pool.ntp.org iburst maxsources 1
#pool 2.ubuntu.pool.ntp.org iburst maxsources 2

# default minpoll 6 maxpoll 10
server 10.10.1.1 iburst prefer minpoll 4 maxpoll 6
</code></pre></div></div> <p>Here, again I’ve commented out lines asking chrony to sync time with internet NTP servers. The <code class="language-plaintext highlighter-rouge">server &lt;ip&gt; iburst prefer</code> line specifies the ip of the time server your machine should use. The <code class="language-plaintext highlighter-rouge">minpoll 4 maxpoll 6</code> part of the line is not necessary. It sets the minimum polling period to $2^{4} = 16$ s and maximum polling period to $2^{6} = 64$ s.</p> <p>After modifying the files, to apply your changes, you’ll need to restart chrony:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl restart chrony
</code></pre></div></div> <p>Having made these changes, I got dramatically better time synchronization. The images below show output of <code class="language-plaintext highlighter-rouge">chronyc tracking</code> after the modifications:</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/time-sync/final-skew-measurement-0-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/time-sync/final-skew-measurement-0-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/time-sync/final-skew-measurement-0-1400.webp"></source> <img src="/assets/img/time-sync/final-skew-measurement-0.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/time-sync/final-skew-measurement-1-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/time-sync/final-skew-measurement-1-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/time-sync/final-skew-measurement-1-1400.webp"></source> <img src="/assets/img/time-sync/final-skew-measurement-1.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>Now, for node-0, you’ll see that all metrics are 0, since it is now our authoritative time server. On node-1, you see that root delay decreased significantly - from 24.5ms to 70μs! This is because now the time server is locally situated. This decrease in root delay also helps time synchronization. The RMSE offset from 2.4ms to 2.5μs! This new time difference which is in order of a few microseconds is sufficient for getting reliable Jaeger traces for microservice applications!</p> <p>Hence, setting up one machine as a local time server, we dramatically improved clock synchronization between our <a href="https://cloudlab.us/" rel="external nofollow noopener" target="_blank">CloudLab</a> machines. This approach might not be the best approach is you want precision in absolute time reporting, however, it is perfect for most distributed systems experiments where time difference between machines is critical.</p> <p>The best part? It’s super easy to set up. Just a few config file tweaks, and you’re on your way to microsecond-level time synchronization!</p> <p>Here are the full <code class="language-plaintext highlighter-rouge">/etc/chrony/chrony.conf</code> config files if you are interested:</p> <ul> <li><a href="/assets/img/time-sync/initial-chrony-conf-0.txt">Initial config file for node-0</a></li> <li><a href="/assets/img/time-sync/initial-chrony-conf-1.txt">Initial config file for node-1</a></li> <li><a href="/assets/img/time-sync/final-chrony-conf-0.txt">Modified config file for node-0</a></li> <li><a href="/assets/img/time-sync/final-chrony-conf-1.txt">Modified config file for node-1</a></li> </ul> </div> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2025 Varun Gohil. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?c9d9dd48933de3831b3ee5ec9c209cac" type="text/javascript"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>